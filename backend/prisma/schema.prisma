// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  socialAccounts SocialAccount[]
  posts          Post[]
  aiConfigs      AIConfig[]
  refreshTokens  RefreshToken[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

model SocialAccount {
  id           String   @id @default(cuid())
  userId       String
  platform     Platform
  platformId   String
  username     String
  displayName  String?
  avatar       String?
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts Post[]

  @@unique([userId, platform, platformId])
  @@map("social_accounts")
}

enum Platform {
  TWITTER
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  TIKTOK
}

model Post {
  id              String     @id @default(cuid())
  userId          String
  socialAccountId String
  platform        Platform
  content         String     @db.Text
  mediaUrls       String[]
  status          PostStatus @default(DRAFT)
  scheduledFor    DateTime?
  publishedAt     DateTime?
  platformPostId  String?
  aiGenerated     Boolean    @default(false)
  aiPrompt        String?    @db.Text
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  analytics     Analytics[]
  autoReplies   AutoReply[]

  @@index([userId])
  @@index([socialAccountId])
  @@index([status])
  @@index([scheduledFor])
  @@map("posts")
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

model Analytics {
  id          String   @id @default(cuid())
  postId      String
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  views       Int      @default(0)
  engagement  Float    @default(0)
  reach       Int      @default(0)
  clicks      Int      @default(0)
  metadata    Json?
  recordedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("analytics")
}

model AutoReply {
  id          String   @id @default(cuid())
  postId      String
  commentId   String
  platform    Platform
  commentText String   @db.Text
  replyText   String   @db.Text
  sentiment   String?
  isAI        Boolean  @default(true)
  repliedAt   DateTime @default(now())
  createdAt   DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([platform, commentId])
  @@index([postId])
  @@map("auto_replies")
}

model AIConfig {
  id           String   @id @default(cuid())
  userId       String
  provider     String   @default("openai")
  model        String
  temperature  Float    @default(0.7)
  maxTokens    Int      @default(2000)
  systemPrompt String?  @db.Text
  isDefault    Boolean  @default(false)
  settings     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_configs")
}

model ScheduledTask {
  id          String   @id @default(cuid())
  type        String
  payload     Json
  scheduledAt DateTime
  status      String   @default("pending")
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  error       String?  @db.Text
  executedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([scheduledAt])
  @@index([status])
  @@map("scheduled_tasks")
}

model WebhookLog {
  id        String   @id @default(cuid())
  platform  Platform
  event     String
  payload   Json
  processed Boolean  @default(false)
  error     String?  @db.Text
  createdAt DateTime @default(now())

  @@index([platform])
  @@index([processed])
  @@map("webhook_logs")
}
