// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  role      Role     @default(USER)

  // Subscription fields
  stripeCustomerId    String?    @unique
  subscriptionStatus  SubscriptionStatus @default(TRIAL)
  trialEndsAt         DateTime?
  onboardingCompleted Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  socialAccounts SocialAccount[]
  posts          Post[]
  aiConfigs      AIConfig[]
  refreshTokens  RefreshToken[]
  brandProfiles  BrandProfile[]
  subscriptions  Subscription[]
  usageMetrics   UsageMetrics[]
  contacts       Contact[]
  emailCampaigns EmailCampaign[]
  contactLists   ContactList[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

model SocialAccount {
  id           String   @id @default(cuid())
  userId       String
  platform     Platform
  platformId   String
  username     String
  displayName  String?
  avatar       String?
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts Post[]

  @@unique([userId, platform, platformId])
  @@map("social_accounts")
}

enum Platform {
  TWITTER
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  TIKTOK
}

model Post {
  id              String     @id @default(cuid())
  userId          String
  socialAccountId String
  platform        Platform
  content         String     @db.Text
  mediaUrls       String[]
  status          PostStatus @default(DRAFT)
  scheduledFor    DateTime?
  publishedAt     DateTime?
  platformPostId  String?
  aiGenerated     Boolean    @default(false)
  aiPrompt        String?    @db.Text
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  analytics     Analytics[]
  autoReplies   AutoReply[]

  @@index([userId])
  @@index([socialAccountId])
  @@index([status])
  @@index([scheduledFor])
  @@map("posts")
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

model Analytics {
  id          String   @id @default(cuid())
  postId      String
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  views       Int      @default(0)
  engagement  Float    @default(0)
  reach       Int      @default(0)
  clicks      Int      @default(0)
  metadata    Json?
  recordedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("analytics")
}

model AutoReply {
  id          String   @id @default(cuid())
  postId      String
  commentId   String
  platform    Platform
  commentText String   @db.Text
  replyText   String   @db.Text
  sentiment   String?
  isAI        Boolean  @default(true)
  repliedAt   DateTime @default(now())
  createdAt   DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([platform, commentId])
  @@index([postId])
  @@map("auto_replies")
}

model AIConfig {
  id           String   @id @default(cuid())
  userId       String
  provider     String   @default("openai")
  model        String
  temperature  Float    @default(0.7)
  maxTokens    Int      @default(2000)
  systemPrompt String?  @db.Text
  isDefault    Boolean  @default(false)
  settings     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_configs")
}

model ScheduledTask {
  id          String   @id @default(cuid())
  type        String
  payload     Json
  scheduledAt DateTime
  status      String   @default("pending")
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  error       String?  @db.Text
  executedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([scheduledAt])
  @@index([status])
  @@map("scheduled_tasks")
}

model WebhookLog {
  id        String   @id @default(cuid())
  platform  Platform
  event     String
  payload   Json
  processed Boolean  @default(false)
  error     String?  @db.Text
  createdAt DateTime @default(now())

  @@index([platform])
  @@index([processed])
  @@map("webhook_logs")
}

model BrandProfile {
  id          String   @id @default(cuid())
  userId      String
  name        String
  tagline     String?
  description String?  @db.Text
  isActive    Boolean  @default(true)

  // Brand Voice & Tone
  brandVoice  String?  @db.Text  // e.g., "professional", "casual", "friendly"
  toneAttributes Json? // e.g., ["authentic", "innovative", "trustworthy"]
  writingStyle String? @db.Text // e.g., "concise", "storytelling", "data-driven"

  // Target Audience
  targetAudience String? @db.Text
  audienceDemographics Json?

  // Brand Values & Mission
  mission     String?  @db.Text
  vision      String?  @db.Text
  values      String[] // e.g., ["innovation", "sustainability", "customer-first"]

  // Visual Identity
  primaryColor   String? // Hex color
  secondaryColor String? // Hex color
  accentColor    String? // Hex color
  logoUrl        String?
  brandAssets    String[] // URLs to uploaded assets

  // Content Guidelines
  keywords       String[] // Important keywords to include
  hashtags       String[] // Preferred hashtags
  dosList        String[] // Things to do
  dontsList      String[] // Things to avoid

  // Example Content
  examplePosts   Json? // Array of example posts
  contentThemes  String[] // e.g., ["product updates", "thought leadership"]

  // Additional Guidelines
  styleGuideUrl  String? // URL to style guide PDF
  competitorUrls String[] // Competitor accounts for reference
  additionalNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("brand_profiles")
}

// SaaS Subscription Models

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum PlanTier {
  FREE
  PRO
  BUSINESS
}

model SubscriptionPlan {
  id          String   @id @default(cuid())
  name        String   // "Free", "Pro", "Business"
  tier        PlanTier @unique
  price       Int      // Price in cents (e.g., 2900 = $29.00)
  interval    String   @default("month") // "month" or "year"

  // Feature Limits
  maxSocialAccounts Int      @default(1)
  maxPostsPerMonth  Int      @default(10)
  maxBrandProfiles  Int      @default(1)
  maxTeamMembers    Int      @default(1)

  // Feature Flags
  advancedAI        Boolean  @default(false)
  analytics         Boolean  @default(false)
  autoReplies       Boolean  @default(false)
  customBranding    Boolean  @default(false)
  apiAccess         Boolean  @default(false)
  prioritySupport   Boolean  @default(false)

  stripePriceId     String?  @unique
  isActive          Boolean  @default(true)
  description       String?  @db.Text
  features          Json?    // Additional features as JSON

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  subscriptions     Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String
  planId               String

  stripeSubscriptionId String?  @unique
  stripePriceId        String?
  stripeProductId      String?

  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  canceledAt           DateTime?

  trialStart           DateTime?
  trialEnd             DateTime?

  metadata             Json?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  payments PaymentHistory[]

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model PaymentHistory {
  id                 String   @id @default(cuid())
  subscriptionId     String

  stripePaymentId    String   @unique
  stripeInvoiceId    String?  @unique

  amount             Int      // Amount in cents
  currency           String   @default("usd")
  status             String   // "succeeded", "failed", "pending"

  paymentMethod      String?  // "card", "bank_transfer", etc.
  lastFourDigits     String?

  receiptUrl         String?
  invoiceUrl         String?

  paidAt             DateTime?
  failedAt           DateTime?

  metadata           Json?

  createdAt          DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("payment_history")
}

model UsageMetrics {
  id                String   @id @default(cuid())
  userId            String

  // Current Month Usage
  month             String   // Format: "2025-01" for January 2025

  postsCreated      Int      @default(0)
  postsScheduled    Int      @default(0)
  postsPublished    Int      @default(0)
  aiGenerations     Int      @default(0)
  socialAccountsUsed Int     @default(0)

  // Storage Usage
  mediaStorageBytes BigInt   @default(0)

  // Last Reset
  lastReset         DateTime @default(now())

  metadata          Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([userId])
  @@map("usage_metrics")
}

// Email Campaign Models

enum ContactSource {
  SOCIAL_MEDIA
  CSV_IMPORT
  MANUAL
  API
  INTEGRATION
}

enum CampaignStatus {
  DRAFT
  GENERATING
  READY
  SCHEDULED
  SENDING
  COMPLETED
  PAUSED
  CANCELLED
}

enum EmailStatus {
  PENDING
  GENERATING
  GENERATED
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  UNSUBSCRIBED
  SPAM
}

enum AIModelType {
  LOCAL_LLM
  OPENAI
  ANTHROPIC
}

model Contact {
  id              String        @id @default(cuid())
  userId          String
  email           String
  firstName       String?
  lastName        String?
  fullName        String?
  company         String?
  jobTitle        String?
  location        String?
  phone           String?
  website         String?
  source          ContactSource @default(MANUAL)
  sourceId        String?       // ID from the source platform
  profileData     Json?         // Social media profiles, bio, etc.
  customFields    Json?         // User-defined custom fields
  isSubscribed    Boolean       @default(true)
  isVerified      Boolean       @default(false)
  unsubscribedAt  DateTime?
  lastContactedAt DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags               ContactTag[]
  interactions       ContactInteraction[]
  campaignContacts   CampaignContact[]
  contactListMembers ContactListMember[]

  @@unique([userId, email])
  @@index([userId])
  @@index([email])
  @@index([source])
  @@map("contacts")
}

model ContactTag {
  id        String   @id @default(cuid())
  contactId String
  tag       String
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactId, tag])
  @@index([contactId])
  @@index([tag])
  @@map("contact_tags")
}

model ContactInteraction {
  id              String   @id @default(cuid())
  contactId       String
  interactionType String   // "email_sent", "email_opened", "social_media_interaction", etc.
  platform        String?  // Twitter, LinkedIn, etc.
  interactionData Json?
  summary         String?  @db.Text
  occurredAt      DateTime @default(now())
  createdAt       DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([platform])
  @@map("contact_interactions")
}

model EmailCampaign {
  id                        String         @id @default(cuid())
  userId                    String
  name                      String
  description               String?        @db.Text
  subjectTemplate           String
  campaignGoal              String?        @db.Text
  targetTags                String[]
  aiModelType               AIModelType    @default(LOCAL_LLM)
  aiModelName               String         @default("llama3")
  personalizationInstructions String?      @db.Text
  personalizationLevel      String         @default("MEDIUM") // LOW, MEDIUM, HIGH
  includeSocialContext      Boolean        @default(true)
  includeInteractionHistory Boolean        @default(true)
  status                    CampaignStatus @default(DRAFT)

  // Statistics
  totalContacts    Int @default(0)
  emailsGenerated  Int @default(0)
  emailsSent       Int @default(0)
  emailsDelivered  Int @default(0)
  emailsOpened     Int @default(0)
  emailsClicked    Int @default(0)
  emailsBounced    Int @default(0)
  emailsFailed     Int @default(0)

  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  templates        EmailTemplate[]
  campaignContacts CampaignContact[]

  @@index([userId])
  @@index([status])
  @@map("email_campaigns")
}

model EmailTemplate {
  id           String   @id @default(cuid())
  campaignId   String
  templateName String
  baseTemplate String   @db.Text
  placeholders Json?    // Available placeholders
  htmlTemplate String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("email_templates")
}

model CampaignContact {
  id                   String      @id @default(cuid())
  campaignId           String
  contactId            String
  personalizedSubject  String?
  personalizedContent  String?     @db.Text
  htmlContent          String?     @db.Text
  status               EmailStatus @default(PENDING)
  aiGenerationTimeMs   Int?
  sendAttempts         Int         @default(0)
  errorMessage         String?     @db.Text
  sentAt               DateTime?
  deliveredAt          DateTime?
  openedAt             DateTime?
  clickedAt            DateTime?
  bouncedAt            DateTime?
  unsubscribedAt       DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  campaign      EmailCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact       Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
  trackingEvents EmailTracking[]

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@map("campaign_contacts")
}

model EmailTracking {
  id                String   @id @default(cuid())
  campaignContactId String
  eventType         String   // "opened", "clicked", "bounced", etc.
  eventData         Json?
  ipAddress         String?
  userAgent         String?
  occurredAt        DateTime @default(now())

  campaignContact CampaignContact @relation(fields: [campaignContactId], references: [id], onDelete: Cascade)

  @@index([campaignContactId])
  @@index([eventType])
  @@map("email_tracking")
}

model ContactList {
  id             String   @id @default(cuid())
  userId         String
  name           String
  description    String?  @db.Text
  isDynamic      Boolean  @default(false)
  filterCriteria Json?    // For dynamic lists
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  members ContactListMember[]

  @@index([userId])
  @@map("contact_lists")
}

model ContactListMember {
  id        String   @id @default(cuid())
  listId    String
  contactId String
  addedAt   DateTime @default(now())

  list    ContactList @relation(fields: [listId], references: [id], onDelete: Cascade)
  contact Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([listId, contactId])
  @@index([listId])
  @@index([contactId])
  @@map("contact_list_members")
}
